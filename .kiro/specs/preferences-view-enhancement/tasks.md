# 实现计划：偏好设置视图增强

## 概述

本实现计划将现有的 PreferencesView 重构为一个专业、用户友好的设置界面，包含输入验证、错误处理和改进的视觉设计。实现将遵循 SwiftUI 最佳实践和 MVVM 架构模式。

## 任务

- [x] 1. 创建核心数据结构和验证逻辑
  - 创建 ValidationError 枚举定义所有验证错误类型
  - 创建 PreferencesData 结构体封装所有设置数据
  - 实现 ValidationState 结构体及其验证方法
  - 添加布局常量和样式定义
  - _需求: 2.1, 2.2_

- [ ]* 1.1 为验证逻辑编写属性测试
  - **属性 1: API 密钥验证拒绝无效输入**
  - **验证需求: 2.1**

- [ ]* 1.2 为 URL 验证编写属性测试
  - **属性 2: API URL 验证要求 HTTPS**
  - **验证需求: 2.2**

- [x] 2. 实现可重用的表单组件
  - [x] 2.1 创建 FormField 组件用于一致的字段布局
    - 支持标签、错误消息和自定义内容
    - 实现错误状态的视觉反馈
    - _需求: 2.3, 2.5_

  - [x] 2.2 创建 SystemPromptEditor 组件
    - 实现多行文本编辑器
    - 添加字符计数显示
    - 实现超长警告逻辑
    - 添加重置为默认按钮
    - _需求: 5.1, 5.2, 5.3, 5.5_

  - [ ]* 2.3 为 SystemPromptEditor 编写属性测试
    - **属性 8: 字符计数准确性**
    - **属性 9: 超长提示词警告**
    - **验证需求: 5.2, 5.3**

  - [x] 2.4 创建 ProviderPicker 组件
    - 实现提供商选择器
    - 定义 Provider 数据模型
    - _需求: 3.1_

- [x] 3. 重构 PreferencesView 主视图
  - [x] 3.1 添加状态管理属性
    - 添加 validationErrors 字典
    - 添加 showSuccessMessage 标志
    - 添加 hasUnsavedChanges 标志
    - 添加临时存储属性（用于取消操作）
    - _需求: 6.2, 7.1, 7.4_

  - [x] 3.2 实现初始化和数据加载
    - 在 init 中加载临时值
    - 设置初始验证状态
    - _需求: 6.5_

  - [x] 3.3 实现核心方法
    - 实现 validateAllFields() 方法
    - 实现 saveSettings() 方法（包含验证和通知）
    - 实现 cancelChanges() 方法
    - 实现 loadTemporaryValues() 和 restoreFromTemporary() 方法
    - _需求: 6.1, 6.3, 6.4, 6.5_

  - [ ]* 3.4 为保存/取消逻辑编写属性测试
    - **属性 11: 设置保存通知发布**
    - **属性 12: 取消操作恢复原值**
    - **验证需求: 6.4, 6.5**

- [x] 4. 检查点 - 确保核心逻辑测试通过
  - 确保所有测试通过，如有疑问请询问用户。

- [x] 5. 重构风格设置标签
  - [x] 5.1 使用 SystemPromptEditor 组件替换现有编辑器
    - 集成字符计数显示
    - 添加超长警告提示
    - 添加重置按钮
    - _需求: 5.1, 5.2, 5.3, 5.5_

  - [x] 5.2 改进布局和间距
    - 应用 LayoutConstants 中的间距值
    - 使用 FormField 包装器
    - _需求: 1.1, 1.2_

  - [ ]* 5.3 为格式保留编写属性测试
    - **属性 10: 系统提示词格式保留（往返）**
    - **验证需求: 5.4**

- [x] 6. 重构模型设置标签
  - [x] 6.1 集成 ProviderPicker 组件
    - 替换现有的 Picker
    - 实现提供商切换逻辑
    - _需求: 3.1_

  - [x] 6.2 实现提供商特定字段可见性
    - 根据选择的提供商显示/隐藏字段
    - 为通义千问添加特定配置
    - _需求: 3.2, 3.5_

  - [ ]* 6.3 为提供商字段可见性编写属性测试
    - **属性 5: 提供商特定字段可见性**
    - **验证需求: 3.1, 3.5**

  - [x] 6.4 添加输入验证和错误显示
    - 为 API 密钥字段添加实时验证
    - 为 API URL 字段添加实时验证
    - 为模型字段添加验证
    - 使用 FormField 显示错误消息
    - _需求: 2.1, 2.2, 2.3_

  - [ ]* 6.5 为验证错误显示编写属性测试
    - **属性 3: 验证错误显示**
    - **验证需求: 2.3, 7.2**

  - [x] 6.6 改进布局和占位符文本
    - 应用一致的间距
    - 添加有用的占位符文本
    - _需求: 1.1, 3.3_

- [x] 7. 重构关于标签
  - [x] 7.1 改进角色选择器
    - 保持现有的 Picker 功能
    - 添加角色数量显示
    - _需求: 4.1, 4.5_

  - [ ]* 7.2 为角色管理编写属性测试
    - **属性 6: 角色选择同步后端状态**
    - **属性 7: 角色数量显示准确性**
    - **验证需求: 4.3, 4.5**

  - [x] 7.2 改进布局和视觉设计
    - 优化图标和文本布局
    - 应用一致的间距
    - _需求: 1.1_

- [x] 8. 实现保存/取消按钮逻辑
  - [x] 8.1 创建操作按钮组
    - 实现保存按钮（调用 saveSettings()）
    - 实现取消按钮（调用 cancelChanges()）
    - 根据验证状态禁用/启用保存按钮
    - _需求: 6.1, 6.2, 2.4_

  - [ ]* 8.2 为保存按钮状态编写属性测试
    - **属性 4: 保存按钮状态与验证结果一致**
    - **验证需求: 2.4, 6.3**

  - [x] 8.3 添加成功/错误消息显示
    - 实现成功消息横幅（2 秒后消失）
    - 实现错误警告对话框
    - _需求: 7.1, 7.2_

  - [x] 8.4 实现未保存更改指示器
    - 监听字段变化
    - 更新 hasUnsavedChanges 标志
    - 在标题或按钮附近显示指示器
    - _需求: 7.4_

  - [ ]* 8.5 为未保存更改标记编写属性测试
    - **属性 13: 未保存更改标记**
    - **验证需求: 7.4**

- [x] 9. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有疑问请询问用户。

- [x] 10. 添加可访问性和键盘支持
  - [x] 10.1 添加可访问性标签
    - 为所有表单字段添加 .accessibilityLabel()
    - 为按钮添加描述性标签
    - _需求: 8.1, 8.4_

  - [x] 10.2 实现键盘快捷键
    - 添加 ⌘S 保存快捷键
    - 添加 ⌘W 关闭快捷键
    - 添加 Escape 取消快捷键
    - _需求: 8.5_

  - [x] 10.3 优化键盘导航
    - 确保 Tab 键可以在字段间导航
    - 设置合理的焦点顺序
    - _需求: 8.2_

- [ ] 11. 最终集成和测试
  - [x] 11.1 更新 PetApp.swift 中的窗口配置
    - 调整窗口大小为 500x400
    - 确保窗口居中显示
    - _需求: 1.5_

  - [ ] 11.2 测试完整的保存/取消工作流程
    - 测试修改后保存
    - 测试修改后取消
    - 测试验证错误场景
    - 测试提供商切换
    - 测试角色切换
    - _需求: 所有_

  - [ ]* 11.3 编写集成测试
    - 测试完整的用户工作流程
    - 测试边界情况
    - _需求: 所有_

- [ ] 12. 最终检查点
  - 确保所有测试通过，如有疑问请询问用户。

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以加快 MVP 开发
- 每个任务都引用特定需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
