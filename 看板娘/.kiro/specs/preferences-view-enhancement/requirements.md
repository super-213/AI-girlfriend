# 需求文档

## 简介

本规范定义了桌面宠物应用程序偏好设置界面（PreferencesView）的增强需求。目标是创建一个专业、用户友好的设置界面，遵循 macOS 设计指南和 Swift/SwiftUI 最佳实践。

## 术语表

- **偏好设置视图（PreferencesView）**: 用户配置 AI 模型、API 凭证和角色行为的设置窗口界面
- **后端（Backend）**: 管理应用程序状态和角色行为的 PetViewBackend 类
- **API管理器（API_Manager）**: 负责与 AI 服务进行 API 通信的 APIManager 类
- **角色（Character）**: 代表桌面宠物的 PetCharacter 实例，包含动画和个性
- **系统提示词（System_Prompt）**: 定义角色行为的 AI 个性配置文本
- **服务提供商（Provider）**: AI 服务提供商（智谱或通义千问）

## 需求

### 需求 1：视觉设计与布局

**用户故事：** 作为用户，我希望有一个视觉上吸引人且组织良好的偏好设置界面，以便我可以轻松导航和配置设置。

#### 验收标准

1. 偏好设置视图 应当 在各部分之间使用 16-20 点的一致间距
2. 偏好设置视图 应当 使用适当的对齐方式，前导/尾随填充为 20 点
3. 当 显示表单字段时，偏好设置视图 应当 使用带有节标题的清晰视觉层次结构
4. 偏好设置视图 应当 使用具有适当样式的 macOS 原生 UI 组件
5. 偏好设置视图 应当 保持最小窗口大小为 500x400 点以确保可读性

### 需求 2：输入验证

**用户故事：** 作为用户，我希望对无效输入获得即时反馈，以便我可以在保存前纠正配置错误。

#### 验收标准

1. 当 用户输入 API 密钥时，偏好设置视图 应当 验证它不为空或默认占位符
2. 当 用户输入 API 地址时，偏好设置视图 应当 验证它是格式正确的 HTTPS URL
3. 如果 输入字段包含无效数据，那么 偏好设置视图 应当 显示带有红色文本的内联错误消息
4. 当 验证失败时，偏好设置视图 应当 禁用保存按钮
5. 偏好设置视图 应当 为无效字段提供视觉反馈（边框颜色变化）

### 需求 3：API 配置管理

**用户故事：** 作为用户，我希望使用适当的设置配置不同的 AI 提供商，以便我可以无缝切换服务。

#### 验收标准

1. 当 用户选择提供商时，偏好设置视图 应当 显示特定于提供商的配置字段
2. 当 从智谱切换到通义千问时，偏好设置视图 应当 显示适合通义千问的模型选项
3. 偏好设置视图 应当 为每个配置字段提供有用的占位符文本
4. 偏好设置视图 应当 突出显示当前提供商名称
5. 在 字段特定于提供商的情况下，偏好设置视图 应当 根据提供商选择显示/隐藏它

### 需求 4：角色管理

**用户故事：** 作为用户，我希望预览和选择不同的角色，以便我可以自定义我的桌面宠物体验。

#### 验收标准

1. 当 显示可用角色时，偏好设置视图 应当 在清晰的选择器中显示角色名称
2. 偏好设置视图 应当 突出显示当前选定的角色名称
3. 当 用户选择新角色时，偏好设置视图 应当 立即更新后端
4. 偏好设置视图 应当 在角色切换成功时提供视觉确认
5. 偏好设置视图 应当 显示角色数量信息

### 需求 5：系统提示词配置

**用户故事：** 作为开发者，我希望通过系统提示词自定义 AI 个性，以便我可以精确定义角色行为。

#### 验收标准

1. 偏好设置视图 应当 为系统提示词提供多行文本编辑器
2. 偏好设置视图 应当 显示系统提示词的字符计数
3. 当 系统提示词超过 500 个字符时，偏好设置视图 应当 显示警告
4. 偏好设置视图 应当 在系统提示词中保留换行符和格式
5. 偏好设置视图 应当 提供重置按钮以恢复默认系统提示词

### 需求 6：保存和取消操作

**用户故事：** 作为用户，我希望有清晰的保存和取消操作，以便我可以控制何时应用更改。

#### 验收标准

1. 偏好设置视图 应当 提供应用所有更改的保存按钮
2. 偏好设置视图 应当 提供丢弃所有更改的取消按钮
3. 当 单击保存按钮时，偏好设置视图 应当 在保存前验证所有输入
4. 当 验证成功时，偏好设置视图 应当 发布设置更改通知
5. 当 单击取消按钮时，偏好设置视图 应当 将所有字段恢复为保存的值

### 需求 7：用户反馈和状态

**用户故事：** 作为用户，我希望对我的操作获得视觉反馈，以便我知道操作何时成功或失败。

#### 验收标准

1. 当 设置成功保存时，偏好设置视图 应当 显示成功消息 2 秒
2. 如果 保存失败，那么 偏好设置视图 应当 显示带有详细信息的错误警报
3. 偏好设置视图 应当 使用颜色编码（绿色表示成功，红色表示错误）
4. 当 字段被修改时，偏好设置视图 应当 指示未保存的更改
5. 偏好设置视图 应当 在保存操作期间禁用交互

### 需求 8：可访问性和本地化

**用户故事：** 作为用户，我希望可访问且正确本地化的界面元素，以便不同受众可以使用该应用程序。

#### 验收标准

1. 偏好设置视图 应当 为所有表单字段使用语义标签
2. 偏好设置视图 应当 支持字段之间的键盘导航
3. 偏好设置视图 应当 在整个界面中一致使用中文文本
4. 偏好设置视图 应当 为屏幕阅读器提供可访问性标签
5. 偏好设置视图 应当 支持标准 macOS 键盘快捷键（⌘S 保存，⌘W 关闭）
