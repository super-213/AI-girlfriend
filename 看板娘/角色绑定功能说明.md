# 角色绑定功能说明

## 功能概述

在偏好设置中新增了"角色绑定"标签页，位于"布局"和"关于"之间。该功能允许用户导入、管理和切换自定义角色。

## 主要功能

### 1. 角色切换
- 从"关于"标签页移动到"角色绑定"标签页
- 支持在内置角色和自定义角色之间切换
- 显示当前可用角色总数（内置 + 自定义）

### 2. 自定义角色管理
- **导入角色**：最多支持3个自定义角色
  - 必须提供站立GIF（normalGif）
  - 可选提供动作GIF（clickGif），如不提供则使用站立GIF
  - 需要为角色命名
  
- **删除角色**：可以删除已导入的自定义角色
  - 删除角色时会同时删除相关的GIF文件
  
- **保存角色**：自定义角色数据保存在UserDefaults中
  - GIF文件复制到Resources/Animations目录

### 3. 文件存储位置
- 自定义GIF文件保存在：`~/Library/Application Support/{BundleID}/CustomAnimations/`
- 这是应用的可写目录，不会有权限问题
- 文件命名规则：
  - 站立GIF：`{角色名称}_站立.gif`
  - 动作GIF：`{角色名称}_动作.gif`

## 技术实现

### 修改的文件

1. **Sources/ViewModels/PreferencesViewBackend.swift**
   - 添加了`customCharacters`属性来存储自定义角色
   - 实现了`importGIF`、`deleteCustomCharacter`、`saveCustomCharacters`等方法
   - 添加了角色绑定相关的错误处理

2. **Sources/Views/PreferencesView.swift**
   - 添加了`characterBindingTab`视图
   - 实现了GIF文件导入对话框
   - 更新了角色选择器以支持自定义角色
   - 简化了"关于"标签页（移除了角色选择器）

3. **Sources/Utils/gif_library.swift**
   - 将`PetCharacter`结构体改为`Codable`以支持序列化
   - 添加了`getAllCharacters()`函数来获取所有角色
   - 修复了`puppetCat`的拼写错误

4. **Sources/Models/PreferencesModels.swift**
   - 在`PreferenceSection`枚举中添加了`characterBinding`选项

## 使用流程

1. 打开偏好设置窗口
2. 点击侧边栏的"角色绑定"
3. 点击"导入"按钮（如果已有3个自定义角色则禁用）
4. 选择站立GIF文件
5. 输入角色名称
6. 选择是否添加动作GIF（可选）
7. 角色导入成功后会显示在列表中
8. 可以在角色选择器中切换到新角色
9. 如需删除，点击角色旁边的垃圾桶图标

## 限制

- 最多支持3个自定义角色
- 只支持GIF格式文件
- 角色名称不能为空
- 必须提供站立GIF文件

## 数据持久化

- 自定义角色信息保存在`UserDefaults`的`customCharacters`键中
- GIF文件保存在 `~/Library/Application Support/{BundleID}/CustomAnimations/` 目录
- 角色数据中保存的是GIF文件的完整路径
- 删除角色时会同时清理相关文件和数据

## 修复的问题

### 1. 权限问题
原本尝试将文件保存到 `Bundle.main.resourcePath`（应用包内的Resources目录），但该目录在运行时是只读的，会导致"You don't have permission"错误。

**解决方案**：改为使用 `Application Support` 目录，这是macOS推荐的应用数据存储位置，具有完整的读写权限。

### 2. 图像加载问题
导入自定义角色后，切换到该角色时图像显示为空。

**原因**：
- `AnimatedImage(name:)` 只能加载Bundle中的资源文件
- 自定义GIF保存在文件系统的Application Support目录中
- 需要使用 `AnimatedImage(url:)` 来加载文件系统中的图像

**解决方案**：
在 `PetView.swift` 中修改图像加载逻辑：
- 检查路径是否以 `/` 开头（绝对路径）
- 如果是绝对路径，使用 `AnimatedImage(url:)` 从文件系统加载
- 如果是相对路径，使用 `AnimatedImage(name:)` 从Bundle加载
- 这样可以同时支持内置角色和自定义角色
